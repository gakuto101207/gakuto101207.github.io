<!DOCTYPE html>
<html>
<head>
  <title>Sight vs Sound</title>
  <meta charset="UTF-8">
  <style>
    div.c {
      margin: auto;
      font-size: 20px;
      text-align: center;
    }
    iframe.c{
      margin: 0;
    }
    input.black {
      -moz-appearance: none;
      -webkit-appearance: none;
      appearance: none;
      margin: 1em 0.3em;
      padding: 0.6em 1em;
      font-size: 1em;
      background-color: black;
      color: #FFF;
      border-radius: 3px;
      border: 0;
      transition: 0.3s;
    }
    input.black:hover {
      background-color: gray;
    }
    input.black:disabled {
      color: gray;
      background: black;
      cursor: not-allowed;
    }
    video {
      border-radius: 10px;
      border: 10px solid #000;
      box-shadow: 0 0 10px #000;
    }
    p {
      line-height: 5px; /* 行の高さを指定する */
      font-size: 1em;
    }
    p.border{
      border-top: 2px dashed black;
      padding-top: 4em;
    }
    span {
      font-size: 1.2em;
    }
  }
  </style>
</head>
<body>
  <div class="c">
    <header>
      <h1>Sight vs Sound</h1>
    </header>
    <div>
      <video id="video" poster="white.jpg" height="480" width="800" autoplay></video>
      <br>
      <p>サンプル番号：<span id="count">0</span> - <span id="sample">0</span>　ビデオタイプ：<span id="type"></span></P>
      <input type="button" value="START" class="black" onClick="prepareVideoOrder(); this.disabled=true;">
      <input type="button" value="NEXT" class="black" onClick="video.play(); CountUp(); video.autoplay = true; this.disabled=true;" id="resumeButton" disabled>
      <input type="button" value="RESET" class="black" onClick="video.play(); video.autoplay = true;" id="reButton" disabled>
      <p id="hide">実験回答フォーム非表示中</p>
    </div>
    <div>
      <div>
        <br>
          <p class="border">IDが表示されます</p>
          <input type="button" class="black" style="width:90px; height:25px; font-size: 0.8em; padding: 0.05em; margin: 0em 0.3em;" value="ID取得" onClick="getid(); this.disabled=true;"></input>
          <input type="text" style="border: 2px solid black; width:200px; height:25px; font-size: 0.8em;" id="number" readonly>
        <br>
      </div>
      <div>
        <br>
          <p>文字列が表示されます</p>
          <input class="border" style="border: 2px solid black; width:400px; height:25px; font-size: 0.8em;" type="text" id="str" readonly>
        <br>
      </div>
    </div>
    <br>
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScnyioHgDhMZ4j-j9eq-KI3HN6Jlpb2xH_p2KkFV7-roduQmQ/viewform?embedded=true" id="form" width="640" height="1350" frameborder="0" marginheight="0" marginwidth="0">読み込んでいます…</iframe>
    <br>
  </div>
</body>
  <script type="text/javascript">

    //初期動作
    function setup() {
      const hide = document.getElementById("hide");
      hide.style.visibility = "hidden";
      alert('実験を開始する前に、下部に表示されるフォーム説明を熟読してください。');
    }
    setTimeout(setup, 100);

    //IDの表示
    function getid() {
      var randoms = [];
      var min = 1, max = 10;
        for(i = min; i <= max; i++){
          while(true){
            var pass = intRandom(min, max);
            if(!randoms.includes(pass)){
              randoms.push(pass);
              break;
            }
          }
        }
        function intRandom(min, max){
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        document.getElementById("number").value = randoms.join("");
    }

    var videolist = [];
    var trialOrder = [];
    var count = 0;
    var load = 0;
    const form = document.getElementById("form");
    //const hide = document.getElementById("hide");
    var button_element = document.getElementById('resumeButton');
    var video = document.getElementById("video");
    var type = document.getElementById("type");
    var rebutton_element = document.getElementById('reButton');
    var sample = document.getElementById("sample");
    // var alphaArray = {a:[1,2,3],b:[1,3,2],c:[2,1,3],d:[2,3,1],e:[3,1,2],f:[3,2,1]};
    // var randNum = shuffle(alphaArray);
    // alphaArray = randNum;

    document.getElementById('form').onload = function () {
      load++;
      if(load > 1 && load <= 9){
        form.style.visibility = "hidden";
        hide.style.visibility = "visible";
        window.scroll(0,0);
        rebutton_element.disabled= true;
        button_element.disabled = false;
      }
      else if (load > 9) {
        form.style.visibility = "visible";
        setTimeout(endscript, 100);
      }
    }

    function prepareVideoOrder(){
      var triad = createRandomOrder(9);
      var ran = ["AO", "AV", "VO", "AO", "AV", "VO", "AO", "AV", "VO"];
      document.getElementById("count").innerHTML = ++count;
      sample.innerHTML = "1";

      for (var i = 0; i < triad.length; i++) {
        var ra = Math.floor(Math.random() * ran.length);
        var r = ran[ra];
        ran.splice(ra, 1);
        var tmptmp = triad[i];
        var condOrder = createRandomOrder(3);

        for (var k = 0; k < 3; k++) {
          videoname = r + tmptmp + "-" + condOrder[k] + "_6.mp4";
          videolist.push(videoname);
        }

        var tmp_condOrder = "";
        switch (condOrder.join('')) {
          case "123":
            tmp_condOrder = "a";
            break;
          case "132":
            tmp_condOrder = "b";
            break;
          case "213":
            tmp_condOrder = "c";
            break;
          case "231":
            tmp_condOrder = "d";
            break;
          case "312":
            tmp_condOrder = "e";
            break;
          case "321":
            tmp_condOrder = "f";
            break;
          default:
            console.log('check');
            break;
        }
        trialOrder.push(String(r)+String(tmptmp)+tmp_condOrder);
      }
      playVideo();
    }

    //ビデオの再生
    //配列の中身の順番にvideolistを選択

    function playVideo(){
      //読み出し
      var videoorder = 0;
      //var button_element = document.getElementById('resumeButton');
      //const form = document.getElementById("form");
      form.style.visibility = "hidden";
      //const vis = document.getElementById("hide");
      hide.style.visibility = "visible";

      video.src = videolist[videoorder];
      video.load();

      if(videolist[videoorder].substring(0,2) == "AO"){
        type.innerHTML = "Audio-only";
      } else if(videolist[videoorder].substring(0,2) == "VO"){
        type.innerHTML = "Visual-only";
      } else if(videolist[videoorder].substring(0,2) == "AV"){
        type.innerHTML = "AudioVisual";
      }

      button_element.addEventListener('click', function(){
        if(videolist[videoorder].substring(0,2) == "AO"){
          type.innerHTML = "Audio-only";
        } else if(videolist[videoorder].substring(0,2) == "VO"){
          type.innerHTML = "Visual-only";
        } else if(videolist[videoorder].substring(0,2) == "AV"){
          type.innerHTML = "AudioVisual";
        }
        type.style.visibility="visible"
      });

      rebutton_element.addEventListener('click', function(){
        videoorder = videoorder - 3;
        video.src = videolist[videoorder];
        if(videolist[videoorder].substring(0,2) == "AO"){
          type.innerHTML = "Audio-only";
        } else if(videolist[videoorder].substring(0,2) == "VO"){
          type.innerHTML = "Visual-only";
        } else if(videolist[videoorder].substring(0,2) == "AV"){
          type.innerHTML = "AudioVisual";
        }
        type.style.visibility="visible"
        form.style.visibility="hidden";
        rebutton_element.disabled="true";
        sample.innerHTML = "1";
      });

      video.addEventListener('ended',function(){
        sleep(2000);
        videoorder++;
        video.src = videolist[videoorder];
        console.log(videoorder);
        console.log(videolist[videoorder]);

        if(videoorder % 3 === 1){
          sample.innerHTML = "2";
        } else if(videoorder % 3 === 2){
          sample.innerHTML = "3";
        } else if(videoorder % 3 === 0){
          video.pause();
          video.autoplay = false;
          rebutton_element.disabled=false;

          if(videoorder != videolist.length){
            alert("ページ下のフォームに第" + count + "問の回答を入力し、次の問題に進んでください。もう一度視聴する場合はRESETボタンをしてください。");
            form.style.visibility="visible";
            hide.style.visibility="hidden";
            video.controls = false;
            type.style.visibility="hidden";
          } else {
            alert("ページ下のフォームに第" + count + "問の回答を入力してください。その後、基本調査への回答もお願いします。もう一度視聴する場合はRESETボタンをしてください。");
            document.getElementById("str").value = trialOrder.join('');
            form.style.visibility="visible";
            hide.style.visibility="hidden";
            video.controls = false;
            type.style.visibility="hidden";
          }
        }
      });
    }

    //再生順決める indexof()文字列を検索　Fisher-Yatesアルゴリズム
    function createRandomOrder(n) {
      var condOrder = [];
      var num = 0;
      while(num < n){
        var x = Math.floor(Math.random()*n+1);
        var tmp = condOrder.indexOf(x);
        if (tmp == "-1"){
          condOrder.push(x);
        }
        num = condOrder.length;
      }
      return condOrder;
    }

    function shuffle(list) {
      var i = list.length;
      while (--i) {
        var j = Math.floor(Math.random() * (i + 1));
        if (i == j) continue;
        var k = list[i];
        list[i] = list[j];
        list[j] = k;
      }
      return list;
    }

    function sleep(waitMsec) {
      var startMsec = new Date();
      while (new Date() - startMsec < waitMsec);
    }

    //問題数のカウント
    function CountUp(){
      document.getElementById("count").innerHTML = ++count;
      sample.innerHTML = "1";
    }

    //お礼
    function endscript(){
      alert('これにて実験は終了となります。ご協力ありがとうございました。');
    }

  </script>
</html>
