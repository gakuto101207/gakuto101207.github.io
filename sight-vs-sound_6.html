<!DOCTYPE html>
<html>
<head>
  <title>Sight-vs-Sound</title>
  <meta charset="UTF-8">
  <style>
    div.c {
      margin: auto;
      font-size: 20px;
      text-align: center;
    }
    iframe.c{
      margin: 0;
    }
    input.black {
      -moz-appearance: none;
      -webkit-appearance: none;
      appearance: none;
      margin: 1em 0.5em;
      margin-bottom: 2em;
      padding: 0.6em 1.2em;
      font-size: 1em;
      background-color: black;
      color: #FFF;
      border-radius: 3px;
      border: 0;
      transition: 0.3s;
    }
    input.black:hover {
      background-color: gray;
    }
    input.black:disabled {
      color: gray;
      background: black;
      cursor: not-allowed;
    }
    div.videoframe {
      margin: auto;
      border-radius: 10px;
      border: 10px solid #000;
      box-shadow: 0 0 10px #000;
      width: 780px;
    }
    p {
      line-height: 5px; /* 行の高さを指定する */
      font-size: 1.1em;
    }
    span {
      font-size: 1.2em;
    }
    .shadow {
      margin: auto;
      margin-bottom: 2em;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
      width: 800px;
    }
    .border {
      border-bottom: 2px solid grey;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      margin: auto;
      margin-bottom: 3em;
      width: 800px;
    }
    h1 {
      font-size: 50px;
      margin-bottom: 1em;
    }
  }
  </style>
</head>
<body>
  <div class="c">
    <header>
      <h1>Sight vs Sound</h1>
    </header>
    <div class="border">
      <div class="videoframe">
        <video id="video" height="480px" width="780px" autoplay></video>
      </div>
      <br>
      <p>サンプル番号：<span id="count">0</span> - <span id="sample">0</span>　ビデオタイプ：<span id="type"></span></P>
      <input type="button" value="PLAY" class="black" onClick="video.play(); CountUp(); video.autoplay = true; this.disabled=true;" id="resumeButton">
      <input type="button" value="REPLAY" class="black" onClick="video.play(); video.autoplay = true;" id="reButton" disabled>
    </div>
    <div class="shadow">
      <div>
        <br>
        <h2>実験回答用紙</h2>
        <div>
          <br>
          <input type="button" class="black" style="width:90px; height:30px; font-size: 0.8em; padding: 0.1em; margin: 1.5em 1.5em;" value="ID取得" onClick="getid(); this.disabled=true;">
          <input type="text" style="border: 2px solid black; width:200px; height:30px; font-size: 0.8em;" id="number" value="" placeholder="IDが表示されます" readonly>
          <br>
        </div>
        <div>
          <input type="text" style="border: 2px solid black; width:400px; height:30px; font-size: 0.8em; margin: 0 0 2em 0;" id="str" value="" placeholder="この実験の最後に文字列が表示されます" readonly>
        </div>
      </div>
      <div>
      <br>
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScnyioHgDhMZ4j-j9eq-KI3HN6Jlpb2xH_p2KkFV7-roduQmQ/viewform?embedded=true" id="form" width="800" height="1000px" frameborder="0" marginheight="0" marginwidth="0">読み込んでいます…</iframe>
      <br>
      </div>
    </div>
  </div>
</body>
  <script type="text/javascript">

    var videolist = [];
    var trialOrder = [];
    var count = 0;
    var load = 0;
    const form = document.getElementById("form");
    var button_element = document.getElementById('resumeButton');
    var video = document.getElementById("video");
    var type = document.getElementById("type");
    var rebutton_element = document.getElementById('reButton');
    var sample = document.getElementById("sample");
    var str = document.getElementById("str");
    window.setTimeout(prepareVideoOrder, 1000);

    //IDの表示設定
    function getid() {
      var randoms = [];
      var min = 1, max = 10;
        for(i = min; i <= max; i++){
          while(true){
            var pass = intRandom(min, max);
            if(!randoms.includes(pass)){
              randoms.push(pass);
              break;
            }
          }
        }
        function intRandom(min, max){
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        document.getElementById("number").value = randoms.join("");
    }

    // var alphaArray = {a:[1,2,3],b:[1,3,2],c:[2,1,3],d:[2,3,1],e:[3,1,2],f:[3,2,1]};
    // var randNum = shuffle(alphaArray);
    // alphaArray = randNum;

    function prepareVideoOrder(){
      var triad = createRandomOrder(9);
      var ran = ["AO", "AV", "VO", "AO", "AV", "VO", "AO", "AV", "VO"];

      for (var i = 0; i < triad.length; i++) {
        var ra = Math.floor(Math.random() * ran.length);
        var r = ran[ra];
        ran.splice(ra, 1);
        var tmptmp = triad[i];
        var condOrder = createRandomOrder(3);

        for (var k = 0; k < 3; k++) {
          videoname = r + tmptmp + "-" + condOrder[k] + "_6.mp4";
          videolist.push(videoname);
        }

        var tmp_condOrder = "";
        switch (condOrder.join('')) {
          case "123":
            tmp_condOrder = "a";
            break;
          case "132":
            tmp_condOrder = "b";
            break;
          case "213":
            tmp_condOrder = "c";
            break;
          case "231":
            tmp_condOrder = "d";
            break;
          case "312":
            tmp_condOrder = "e";
            break;
          case "321":
            tmp_condOrder = "f";
            break;
          default:
            console.log('check');
            break;
        }
        trialOrder.push(String(r)+String(tmptmp)+tmp_condOrder);
      }
      playVideo();
    }

    //ビデオの再生
    //配列の中身の順番にvideolistを選択

    function playVideo(){
      //読み出し
      var videoorder = 0;
      video.src = videolist[videoorder];
      video.load();
      video.pause();
      video.style.visibility = "hidden";

      //PLAYボタン
      button_element.addEventListener('click', function(){
        if(videolist[videoorder].substring(0,2) == "AO"){
          type.innerHTML = "Audio-only";
        } else if(videolist[videoorder].substring(0,2) == "VO"){
          type.innerHTML = "Visual-only";
        } else if(videolist[videoorder].substring(0,2) == "AV"){
          type.innerHTML = "AudioVisual";
        }
        type.style.visibility="visible"
        video.style.visibility = "visible";
      });

      //REPLAYボタン
      rebutton_element.addEventListener('click', function(){
        videoorder = videoorder - 2;
        video.src = videolist[videoorder];
        if(videolist[videoorder].substring(0,2) == "AO"){
          type.innerHTML = "Audio-only";
        } else if(videolist[videoorder].substring(0,2) == "VO"){
          type.innerHTML = "Visual-only";
        } else if(videolist[videoorder].substring(0,2) == "AV"){
          type.innerHTML = "AudioVisual";
        }
        type.style.visibility= "visible";
        video.style.visibility = "visible";
        rebutton_element.disabled = true;
        sample.innerHTML = "1";
      });

      //form読み込み
      document.getElementById('form').onload = function () {
        load++;
        if(load > 0 && load < 9){
          window.scroll(0,0);
          rebutton_element.disabled= true;
          button_element.disabled = false;
          video.pause();
          video.autoplay = false;
          video.style.visibility = "hidden";
          type.style.visibility= "hidden";
          if(videoorder % 3 === 1){
            videoorder = videoorder + 2;
          } else if(videoorder % 3 === 2){
            videoorder = videoorder + 1;
          } else if(videoorder % 3 === 0){
            videoorder = videoorder + 3;
          }
          video.src = videolist[videoorder];
        } else if(load == 9){
          video.pause();
          window.scroll(0,1000);
          video.autoplay = false;
          rebutton_element.disabled= true;
          button_element.disabled = true;
          video.style.visibility = "hidden";
          type.style.visibility = "hidden";
          alert("基本調査フォームの回答をお願いします。");
          str.value = trialOrder.join('');
        } else {
          window.location = "endwindow.html";
        }
      }

      //再生後
      video.addEventListener('ended',function(){
        sleep(1500);
        console.log(videoorder);
        console.log(videolist[videoorder]);

        if(videoorder % 3 === 0){
          sample.innerHTML = "2";
          videoorder++;
          video.src = videolist[videoorder];
        } else if(videoorder % 3 === 1){
          sample.innerHTML = "3";
          videoorder++;
          video.src = videolist[videoorder];
        } else if(videoorder % 3 === 2){
          video.pause();
          video.autoplay = false;
          rebutton_element.disabled=false;

          if(videoorder <= videolist.length){
            alert("ページ下のフォームに第" + count + "問の回答を入力し、次の問題に進んでください。もう一度視聴する場合はREPLAYボタンをしてください。");
            video.style.visibility = "hidden";
          }
        }
      });
    }

    //再生順決める indexof()文字列を検索　Fisher-Yatesアルゴリズム
    function createRandomOrder(n) {
      var condOrder = [];
      var num = 0;
      while(num < n){
        var x = Math.floor(Math.random()*n+1);
        var tmp = condOrder.indexOf(x);
        if (tmp == "-1"){
          condOrder.push(x);
        }
        num = condOrder.length;
      }
      return condOrder;
    }

    function shuffle(list) {
      var i = list.length;
      while (--i) {
        var j = Math.floor(Math.random() * (i + 1));
        if (i == j) continue;
        var k = list[i];
        list[i] = list[j];
        list[j] = k;
      }
      return list;
    }

    function sleep(waitMsec) {
      var startMsec = new Date();
      while (new Date() - startMsec < waitMsec);
    }

    //問題数のカウント
    function CountUp(){
      document.getElementById("count").innerHTML = ++count;
      sample.innerHTML = "1";
    }

  </script>
</html>
